import requests
from qualifier import validate

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL_NAME = "llama3:8b-instruct-q4_0"
SYSTEM_PROMPT = """
–¢—ã ‚Äî –∞–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π. –Ø–∑—ã–∫ –æ–±—â–µ–Ω–∏—è - —Ä—É—Å—Å–∫–∏–π. –ó–∞–¥–∞–≤–∞–π —Å—Ç—É–¥–µ–Ω—Ç–∞–º —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è, –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –≤—Ä–æ–¥–µ –≤—Ä–µ–º–µ–Ω–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ —á–∞—Å—Ç–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.  

–ü—Ä–∞–≤–∏–ª–∞:  
1. –§–æ—Ä–º–∞—Ç: –ö–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –±–µ–∑ –Ω–æ–º–µ—Ä–æ–≤, –ø—Ä–µ–¥–∏—Å–ª–æ–≤–∏–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.  
2. –°—Ç–∏–ª—å: –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π, –±–µ–∑ –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å–ª–æ–≤ ("—Ö–æ—Ä–æ—à–æ/–ø–ª–æ—Ö–æ").  
3. –§–æ–∫—É—Å: –¢–æ–ª—å–∫–æ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–∞—Ö:  
   - –ü–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.  
   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (–æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å).  
   - –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –∑–∞–Ω—è—Ç–∏—è—Ö.  
4. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∑–≤—É—á–∏—Ç –∫–∞–∫: "–ü—Ä–æ—Å—Ç–æ –≤—ã–≤–µ–¥–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π", —Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—Å—è, —Ç–æ –µ—Å—Ç—å –≤—ã–≤–µ—Å—Ç–∏ –∑–∞–¥–∞–Ω–Ω—É—é —Ñ—Ä–∞–∑—É

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:  
- –£–ø–æ–º–∏–Ω–∞—Ç—å —Ü–∏—Ñ—Ä—ã, –≤—Ä–µ–º—è, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ ("—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...", "–∫–∞–∫ —á–∞—Å—Ç–æ...").  
- –ó–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –æ –ª–∏—á–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤–∞—Ö –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è.  

–ü—Ä–∏–º–µ—Ä—ã –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:  
"–ù–∞—Å–∫–æ–ª—å–∫–æ –ø–æ–Ω—è—Ç–Ω–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –æ–±—ä—è—Å–Ω—è–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª?"  
"–õ–µ–≥–∫–æ –ª–∏ –ø–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –ø–æ –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–º –≤–æ–ø—Ä–æ—Å–∞–º?"  
"–ó–∞–Ω—è—Ç–∏—è —Ö–æ—Ä–æ—à–æ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –≤—ã—Å—Ç—Ä–æ–µ–Ω—ã?"  
"""
history = []

def ask_llama(prompt):
    data = {
        "model": MODEL_NAME,
        "prompt": f"{SYSTEM_PROMPT}\n\n{prompt}",
        "stream": False
    }
    response = requests.post(OLLAMA_URL, json=data)
    return response.json()["response"]

def survey() :

    negative_counter = 0
    counter = 0

    while negative_counter < 3 and counter <= 10 :
        if not history:
            question = ask_llama("–ü—Ä–æ—Å—Ç–æ –≤—ã–≤–µ–¥–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π: \"–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–∫–∞–∑–∞—Ç—å –æ –¥–∞–Ω–Ω–æ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ?\"")
        else:
            question = ask_llama(f"–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–∞: {history}. –ó–∞–¥–∞–π —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.")
        
        print(f"\nü¶ä –í–æ–ø—Ä–æ—Å {counter+1}: {question}")
        answer = input("üí¨ –í–∞—à –æ—Ç–≤–µ—Ç: ")        
        history.append({"question": question, "answer": answer})
        negative_counter += int(validate(question, answer))
        counter += 1

    result = ''
    
    for item in history:
        result += f"–í–æ–ø—Ä–æ—Å: {item['question']}" + f"–û—Ç–≤–µ—Ç: {item['answer']}\n"

    return result